{% extends "admin_base.html" %}

{% block content %} 
    <h1>Reservation Status</h1>
    <form id="dateForm">
        <label for="date">Select Date:</label>
        <input type="date" id="date" name="date">
        <input type="button" value="View Schedule" onclick="viewSchedule()">
    </form>

    <div class="row">
        <div class="col-12">
            <!-- Your table will be inserted here -->
            <div id="schedule">
                <!-- AJAX response will be displayed here -->
            </div>
        </div>
    </div>

  <!-- Booking ID Girişi -->
<div id="bookingInput" style="display:none;">
    <!-- Yeni bir input alanı ekleyin -->
    <form id="assignStatusForm">
    <label for="booking_id">Choose Booking ID:</label>
    <select id="anotherSelect" class="form-control">
        <!-- Options will be dynamically added here -->
    </select>

    <div class="form-group">
        <label for="static">Choose status:</label>
            <select id="status" name="status" class="form-control">
                {% for status in status_data %}
                    <option value="{{ status[0] }}">{{ status[0] }}</option>
                {% endfor %}
            </select>
    </div>

        <input type="submit" value="ASSIGN">
    </form>      
</div>


<!-- ... -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        function viewSchedule() {
            const form = document.getElementById('dateForm');
            const date = form.elements['date'].value;

            // AJAX ile Flask view_schedule endpointine istek gönderin
            fetch(`/admin_status`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 'date': date }),
            })
            .then(response => response.json())
            .then(data => {
                const scheduleDiv = document.getElementById('schedule');
                scheduleDiv.innerHTML = '';

                if (data.booking_details && data.booking_details.length > 0) {
                    scheduleDiv.innerHTML = '<h2>Booking Details for ' + data.date + '</h2>';

                    // Create the table element and set its attributes
                    const table = document.createElement('table');
                    table.id = 'example1'; // Add the id to the table
                    table.classList.add('table', 'table-bordered', 'table-striped'); // Add the class
                    createOptionList(data);
                    // Create the table header
                    const tableHeader = document.createElement('thead');
                    tableHeader.innerHTML = `
                        <tr>
                            <th>Booking ID</th>
                            <th>Customer Name</th>
                            <th>Customer Surname</th>
                            <th>Vehicle Type</th>
                            <th>Vehicle Make</th>
                            <th>Service Type</th>
                            <th>Mechanic</th>
                            <th>Status</th>
                        </tr>
                    `;

                    // Create the table body
                    const tableBody = document.createElement('tbody');
                    data.booking_details.forEach(booking => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${booking[0]}</td>
                            <td>${booking[1]}</td>
                            <td>${booking[2]}</td>
                            <td>${booking[3]}</td>
                            <td>${booking[4]}</td>
                            <td>${booking[5]}</td>
                            <td>${booking[6]} ${booking[7]}</td>
                            <td>${booking[8]}</td>
                        `;
                        tableBody.appendChild(row);
                    });

                    // Append header and body to the table
                    table.appendChild(tableHeader);
                    table.appendChild(tableBody);

                    // Append the table to the scheduleDiv
                    scheduleDiv.appendChild(table);

                    // Initialize DataTables for the table with the specified options
                    $(table).DataTable({
                        "responsive": true,
                        "lengthChange": false,
                        "autoWidth": false,
                        "buttons": ["copy", "csv", "excel", "pdf", "print", "colvis"]
                    }).buttons().container().appendTo('#example1_wrapper .col-md-6:eq(0)');

                    // Show Booking ID Girişin 
                    document.getElementById('bookingInput').style.display = 'block';
                  
                } else {
                    scheduleDiv.innerHTML = '<p>No bookings found for the selected date.</p>';
                    // Hide Booking ID Girişi 
                    document.getElementById('bookingInput').style.display = 'none';
                  
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }

        function createOptionList(data) {
            const anotherSelect = document.getElementById('anotherSelect');
            anotherSelect.innerHTML = ''; // Clear any previous options
        
            if (data.booking_details && data.booking_details.length > 0) {
                data.booking_details.forEach(booking => {
                    const option = document.createElement('option');
                    option.value = booking[0]; // Set the booking ID as the option value
                    option.textContent = booking[0]; // Display the booking ID as the option text
                    anotherSelect.appendChild(option);   
                });
            }
        }

   
        $(document).ready(function() {
        // When the form is submitted
        $('#assignStatusForm').on('submit', function(event) {
            event.preventDefault(); // Prevent default form submission

            // Get the selected booking ID and status ID from the form
            var booking_id = $('#anotherSelect').val();
            var booking_status_id = $('#status').val();

            // Create the data to be sent as JSON to the Flask backend
            var data = {
                'booking_id': booking_id,
                'booking_status_id': booking_status_id
            };

            // Send an AJAX POST request to the Flask backend
            $.ajax({
            type: 'POST',
            url: '/update_status',
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: function(response) {
                if (response.success) {
                    // Mechanic updated successfully
                    alert(response.message);
                } else {
                    // Some error occurred or missing data
                    alert(response.message);
                }
            },
            error: function(errorThrown) {
                // Log the error to the console for debugging
                console.error('AJAX Error:', errorThrown);
                alert('An error occurred while sending the request. Please try again later.');
                }
            });
        });
    });

    </script>
{% endblock %}
